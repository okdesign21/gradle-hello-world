---
name: Java CI with Gradle

on:
  push:
    branches: ["master"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  JAVA_VERSION: "21"
  IMAGE_NAME: keplerhello
  VCS_REF: ${{ github.sha }}

jobs:
  megalinter:
    # Static linting and code quality checks using MegaLinter
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: MegaLinter
        uses: oxsecurity/megalinter/flavors/java@v9.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-check:
    # Security checks separate from Linting for reports and future extensions
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "repo"
          exit-code: "1"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"
          output: "trivy-report.txt"

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --results=verified,unknown

      - name: Upload Security Reports
        uses: actions/upload-artifact@v6
        with:
          name: security-reports
          path: trivy-report.txt,trufflehog-results.json

  tests:
    # Unit tests with Gradle
    runs-on: ubuntu-latest
    steps:
      - name: Install Node.js (for act)
        if: ${{ env.ACT }}
        run: |
          apt-get update
          apt-get install -y nodejs npm

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4.2.1

      - name: Run tests
        run: ./gradlew test --no-daemon

  build-and-sign:
    # Build Docker image, generate SBOM, run vulnerability scan, and sign the image
    runs-on: ubuntu-latest
    needs: ["security-check", "tests", "megalinter"]
    permissions:
      contents: write
    outputs:
      version: ${{ steps.bump.outputs.new_version }}
    if: github.ref_name == 'master'
    steps:
      - name: Install Node.js (for act)
        if: ${{ env.ACT }}
        run: |
          apt-get update
          apt-get install -y nodejs npm

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Setup Gradle to generate and submit dependency graphs
        uses: gradle/actions/setup-gradle@v4.2.1
        with:
          dependency-graph: generate-and-submit

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ${{ env.IMAGE_NAME }}:latest
          secrets: |
            cosign_key=${{ secrets.COSIGN_KEY }}
            cosign_password=${{ secrets.COSIGN_PASSWORD }}

      - name: Extract artifacts and version
        id: bump
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          docker create --name extract "$IMAGE_NAME:latest"
          docker cp extract:/app/sbom.spdx.json /tmp/sbom.spdx.json
          docker cp extract:/app/VERSION.txt /tmp/VERSION.txt
          docker cp extract:/app/app.jar /tmp/app.jar
          docker cp extract:/app/app.jar.bundle /tmp/app.jar.bundle
          docker rm extract
          NEW_VERSION=$(cat /tmp/VERSION.txt)
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          exit-code: "1"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Save image as tar
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: docker save "$IMAGE_NAME:latest" -o /tmp/docker-image.tar

      - name: Upload all artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            /tmp/docker-image.tar
            /tmp/sbom.spdx.json
            /tmp/app.jar
            /tmp/app.jar.bundle
          retention-days: 1

  publish:
    # Publish Docker image to DockerHub, sign it with Cosign, and update version in repo
    runs-on: ubuntu-latest
    needs: build-and-sign
    permissions:
      contents: write
    if: github.ref_name == 'master'
    env:
      VERSION: ${{ needs.build-and-sign.outputs.version }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: DockerHub login
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag and push image to DockerHub
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DOCKERHUB_REPO: ${{ vars.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}
          VERSION: ${{ env.VERSION }}
          VCS_REF: ${{ env.VCS_REF }}
        run: |
          docker tag "$IMAGE_NAME:latest" "$DOCKERHUB_REPO:latest"
          docker tag "$IMAGE_NAME:latest" "$DOCKERHUB_REPO:$VERSION"
          docker tag "$IMAGE_NAME:latest" "$DOCKERHUB_REPO:$VCS_REF"
          docker push "$DOCKERHUB_REPO:latest"
          docker push "$DOCKERHUB_REPO:$VERSION"
          docker push "$DOCKERHUB_REPO:$VCS_REF"
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' \
            "$DOCKERHUB_REPO:latest" | cut -d'@' -f2)
          echo "IMAGE_DIGEST=$DIGEST" >> "$GITHUB_ENV"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0

      - name: Sign images with Cosign
        env:
          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          DOCKERHUB_REPO: ${{ vars.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}
          IMAGE_DIGEST: ${{ env.IMAGE_DIGEST }}
        run: |
          test -n "${COSIGN_KEY}" || \
            (echo "ERROR: COSIGN_KEY is required" && exit 1)
          test -n "${COSIGN_PASSWORD}" || \
            (echo "ERROR: COSIGN_PASSWORD is required" && exit 1)
          echo "${COSIGN_KEY}" | base64 -d > /tmp/cosign_key.pem
          COSIGN_PASSWORD="${COSIGN_PASSWORD}" cosign sign \
            --key /tmp/cosign_key.pem --yes \
            "$DOCKERHUB_REPO@$IMAGE_DIGEST"
          rm /tmp/cosign_key.pem

      - name: checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update build.gradle.kts with new version
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" build.gradle.kts

      - name: Commit version bump
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add build.gradle.kts
          git commit -m "chore: bump version to $VERSION [skip ci]"
          git push

  call-home:
    # Check published image and call home
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: read
    if: github.ref_name == 'master'
    steps:
      - name: call home
        env:
          DOCKERHUB_USER: ${{ vars.DOCKERHUB_USER }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          IMAGE="docker.io/$DOCKERHUB_USER/$IMAGE_NAME:latest"
          docker pull "$IMAGE"
          OUTPUT=$(docker run --rm "$IMAGE")
          echo "Container output: $OUTPUT"
          if echo "$OUTPUT" | grep -q "Hello World! I'm OrInbar"; then
            echo "come and get me"
          else
            exit 1
          fi

  release:
    # Create GitHub Release with built artifacts
    runs-on: ubuntu-latest
    needs: [call-home, build-and-sign]
    permissions:
      contents: write
    if: github.ref_name == 'master'
    env:
      VERSION: ${{ needs.build-and-sign.outputs.version }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts
          path: /tmp

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: |
            Automated release of version ${{ env.VERSION }}
          files: |
            /tmp/sbom.spdx.json
            /tmp/app.jar
            /tmp/app.jar.bundle

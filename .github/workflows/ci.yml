---
name: Java CI with Gradle

on:
  push:
    branches: ["master"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  JAVA_VERSION: "21"
  IMAGE_NAME: keplerhello
  VCS_REF: ${{ github.sha }}

jobs:
  megalinter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: MegaLinter
        uses: oxsecurity/megalinter/flavors/java@v9.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "repo"
          exit-code: "1"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"
          output: "trivy-report.txt"

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --results=verified,unknown

      - name: Upload Security Reports
        uses: actions/upload-artifact@v6
        with:
          name: security-reports
          path: trivy-report.txt,trufflehog-results.json

  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Run tests
        run: ./gradlew test --no-daemon

  build-and-sign:
    runs-on: ubuntu-latest
    needs: ["security-check", "megalinter", "tests"]
    permissions:
      contents: write
    outputs:
      version: ${{ steps.bump.outputs.new_version }}
    if: github.ref_name == 'master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "gradle"

      - name: Setup Gradle to generate and submit dependency graphs
        uses: gradle/actions/setup-gradle@v5
        with:
          dependency-graph: generate-and-submit

      - name: Bump version in build.gradle.kts
        id: bump
        run: |
          # Increment only the patch number (X.Y.Z -> X.Y.Z+1) using awk
          NEW_VERSION=$(grep '^version\s*=' build.gradle.kts | sed -E 's/.*"(.*)"/\1/' | awk -F. '{print $1"."$2"."$3+1}')
          sed -i "s/^version = \".*\"/version = \"${NEW_VERSION}\"/" build.gradle.kts
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build Docker image until cosign
        uses: docker/build-push-action@v6
        with:
          context: .
          target: cosign
          push: false
          tags: ${{ env.IMAGE_NAME }}-cosign:latest
          build-args: |
            COSIGN_KEY=${{ secrets.COSIGN_KEY }}
            COSIGN_PASSWORD=${{ secrets.COSIGN_PASSWORD }}

      - name: Extract artifacts from cosign image
        run: |
          docker create --name extract ${{ env.IMAGE_NAME }}-cosign:latest
          mkdir -p build/libs build/sbom
          docker cp extract:/app/app.jar ./build/libs/app.jar
          docker cp extract:/app/sbom.spdx.json ./build/sbom/sbom.spdx.json
          docker cp extract:/app/app.jar.sig ./build/libs/app.jar.sig
          docker rm extract

      - name: Build final image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ${{ env.IMAGE_NAME }}:latest

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.IMAGE_NAME }}:latest
          exit-code: "1"
          ignore-unfixed: true
          severity: "CRITICAL,HIGH"

      - name: Save Docker image as tar
        run: docker save ${{ env.IMAGE_NAME }}:latest -o /tmp/docker-image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v6
        with:
          name: docker-image
          path: /tmp/docker-image.tar
          retention-days: 1

      - name: Upload JAR
        uses: actions/upload-artifact@v6
        with:
          name: jar-artifact
          path: build/libs/*-all.jar

      - name: Upload JAR Signature
        uses: actions/upload-artifact@v6
        with:
          name: jar-signature-artifact
          path: build/libs/app.jar.sig

      - name: Upload SBOM
        uses: actions/upload-artifact@v6
        with:
          name: sbom-artifact
          path: build/sbom/sbom.spdx.json

  publish:
    runs-on: ubuntu-latest
    needs: build-and-sign
    if: github.ref_name == 'master'
    env:
      VERSION: ${{ needs.build-and-sign.outputs.version }}
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v7
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: DockerHub login
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag and push image to DockerHub
        env:
          DOCKERHUB_REPO: ${{ vars.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}
        run: |
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.DOCKERHUB_REPO }}:latest
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.DOCKERHUB_REPO }}:${{ env.VERSION }}
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.DOCKERHUB_REPO }}:${{ env.VCS_REF }}
          docker push ${{ env.DOCKERHUB_REPO }}:latest
          docker push ${{ env.DOCKERHUB_REPO }}:${{ env.VERSION }}
          docker push ${{ env.DOCKERHUB_REPO }}:${{ env.VCS_REF }}

      - name: checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add build.gradle.kts
          git commit -m "chore: bump version to ${{ env.VERSION }} [skip ci]"
          git push

  call-home:
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: read
    if: github.ref_name == 'master'
    steps:
      - name: call home
        env:
          IMAGE: docker.io/${{ vars.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}:latest
        run: |
          docker pull "$IMAGE"
          OUTPUT=$(docker run --rm "$IMAGE")
          echo "Container output: $OUTPUT"
          if echo "$OUTPUT" | grep -q "Hello World! I'm OrInbar"; then
            echo "come and get me"
          else
            exit 1
          fi
